#!/bin/sh

# Run benchmarks associted with each group member
# NOTE: This script does not output to terminal
# ALL jobs run sequentially in background
# USE PID to kill benchmark simulation. 
# IN outputs/ refresh dir to view .out and .log files if they do not show automatically

if [ "$#" -ne 2 ]; then
    echo ""
    echo "Usage: ./run-all-xpolicy <group_member> <repl_policy>"
    echo "    group_member: "
    echo "      -- Zach"
    echo "      -- Rodrigo"
    echo "      -- Brycen"
    echo "    repl_policy: LRU LFU SRRIP RT-RRIP Mockingjay Vantage"
else
    group_member=$1
    repl=$2

    # Define benchmarks for each group member
    case $group_member in
        "Zach")
            benchmarks="gcc xalan namd bodytrack swaptions soplex x264"
            ;;
        "Rodrigo")
            benchmarks="bzip2 hmmer calculix fluidanimate sjeng lbm"
            ;;
        "Brycen")
            benchmarks="mcf cactus blackscholes streamcluster libquantum canneal"
            ;;
        *)
            echo "Unknown group member. Please specify either Zach, Rodrigo, or Brycen."
            exit 1
            ;;
    esac

    # List of PARSEC benchmarks that require _8c_simlarge suffix
    parsec_benchmarks="blackscholes bodytrack fluidanimate streamcluster swaptions canneal x264"

    # Run the entire set of benchmarks in the background
    (
        # Loop through the selected benchmarks and execute them sequentially
        for bench in $benchmarks; do
            # Check if the benchmark is a PARSEC benchmark
            if echo "$parsec_benchmarks" | grep -q -w "$bench"; then
                # For PARSEC benchmarks, use the _8c_simlarge variant
                bench="${bench}_8c_simlarge"
            fi

            # Create the directory for output
            mkdir -p outputs/hw4/$repl/${bench}

            # Execute the benchmark without echoing the command to terminal
            ./build/opt/zsim configs/hw4/$repl/${bench}.cfg > outputs/hw4/$repl/${bench}/${bench}.log 2>&1 &

            # Capture the PID of the zsim process
            zsim_pid=$!
            
            # Wait for the specific zsim PID to finish
            wait $zsim_pid
        done
    ) &  # Run the entire block in the background
fi
